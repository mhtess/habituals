---
title: "habituals-priors-BDA"
author: "mht"
date: "November 24, 2015"
output: html_document
---

```{r}
library(data.table)
library(coda)
estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}
HPDhi<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}
HPDlo<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}
options("scipen"=10)   
```

## Existence question

```{r}
filePath <- "~/Documents/research/habituals/models/priors/results/"
prefix <- "priors2-existenceQ-betaModel-incrMH"
samples <- 100000
burn <- samples / 2
m<- as.data.frame.matrix(fread(paste(filePath, prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.csv",sep="")))

m.samples <- m[rep(row.names(m), m$Probability*(samples-burn)), 1:5]
```

### Posterior over parameters

```{r}
m.params<-m.samples %>% filter(Parameter!='predictive')

ggplot(m.params,aes(x=Value, fill=Gender))+
  geom_histogram(position=position_dodge())+
  facet_grid(Item~Parameter, scales='free')+
  theme(strip.text.y = element_text(angle=0))


ggsave(paste(filePath, "plots/priors2-existence-", prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.pdf", sep=""), height = 14, width = 7)

```


### Posterior predictive


```{r}
m.predictive<-m.samples %>% filter(Parameter=='predictive')

ggplot(m.predictive,aes(x=Value, fill=Gender))+
  geom_histogram(position=position_dodge(), binwidth=0.03)+
  facet_wrap(~Item, scales='fixed')+
  xlab("% of Americans who ___")

ggsave(paste(filePath, "plots/priors2-existence-predictive-", prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.pdf", sep=""))


# fig.path <- "~/Documents/research/habituals/talks/lab-mtg-120115/images/"
# ggsave(paste(fig.path, "existentialQ-bda-histogram-priors1.pdf", sep=""), width = 8, height =5)
```


### Model - data fit


```{r}
d<-read.csv("~/Documents/research/habituals/data/priors/priors-2.csv")

scaleTime2 <- list(
  week = 7,
  month = 30,
  year = 365,
  "5 years" = 5*365
)

d.tidy<- d %>% 
  select(workerid, category, item, ends_with("_men"), ends_with("_women")) %>%
  mutate(menFreq = nPersons_men / comparisonNum_men,
         womenFreq = nPersons_women / comparisonNum_women) %>%
  rowwise() %>%
  mutate(menRate = scaleTime2[[as.character(comparisonTime_men)]]/nInstances_men,
         womenRate = scaleTime2[[as.character(comparisonTime_women)]]/nInstances_women) %>%
  mutate(menRate = ifelse(menRate==Inf, 5*365, menRate),
         womenRate = ifelse(womenRate==Inf, 5*365, womenRate))


# create histogram from responses
d.freq<- d.tidy %>%
  select(item, menFreq, womenFreq) %>%
  gather(Gender, Human, menFreq, womenFreq) %>%
  mutate(Gender = factor(Gender, levels=c("menFreq", "womenFreq"),
                         labels=c("male", "female"))) %>%
  rename(Item = item) %>%
  mutate(Bin = round(Human, digits = 1)) %>%
  mutate(Bin = factor(Bin)) %>%
  group_by(Item, Gender, Bin) %>%
  summarize(count = length(Human)) %>%
  ungroup() %>%
  group_by(Item, Gender) %>%
  mutate(norm_count = count / sum(count)) %>%
  select(-count)


m.freq <- m.predictive %>% 
  mutate(Bin = round(Value, 1)) %>%
  mutate(Bin = factor(Bin)) %>%
  group_by(Item, Gender, Bin) %>%
  summarize(count = length(Value)) %>%
  ungroup() %>%
  group_by(Item, Gender) %>%
  mutate(model_count = count / sum(count)) %>%
  select(-count)

md.freq<- left_join(m.freq, d.freq)
md.freq[is.na(md.freq$norm_count),]$norm_count <- 0

ggplot(md.freq, aes(x=model_count, y=norm_count, color = Bin))+
  geom_point()+
  geom_abline(intercept = 0, slope = 1, lty = 2)+
  coord_fixed()

with(md.freq, cor(model_count, norm_count))^2
```



# Frequency question

```{r freq.load}
prefix <- "waitQ-logNormalModel-incrMH"
samples <- 100000
burn <- samples / 2
m2<- as.data.frame.matrix(fread(paste(filePath, prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.csv",sep="")))

m2.samples <- m2[rep(row.names(m2), m2$Probability*(samples-burn)), 1:5]
```

### Posterior over parameters

```{r}
m2.params<-m2.samples %>% filter(Parameter!='predictive')

ggplot(m2.params,aes(x=Value, fill=Gender))+
  geom_histogram()+
  facet_grid(Item~Parameter, scales='free')+
  theme(strip.text.y = element_text(angle=0))


ggsave(paste(filePath, "plots/priors2-frequency-parameters-", prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.pdf", sep=""), height = 14, width = 7)


m2.params.stats <- m2.params %>%
  group_by(Parameter, Item, Gender) %>%
  summarize(MAP = estimate_mode(Value),
            credHigh = HPDhi(Value),
            credLow = HPDlo(Value))

ggplot(m2.params.stats,
       aes(x=Item, y=MAP, fill=Gender))+
  geom_bar(stat='identity', position=position_dodge())+
  geom_errorbar(aes(ymin = credLow, ymax = credHigh),
                position=position_dodge())+
  facet_wrap(~Parameter)+
  coord_flip()

ggsave(paste(filePath, "plots/priors2-frequency-stats-", prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.pdf", sep=""), height = 8, width = 10)
```


### Posterior predictive


```{r}
m2.predictive<-m2.samples %>% filter(Parameter=='predictive')

ggplot(m2.predictive,aes(x=Value, fill=Gender))+
  geom_histogram(position=position_dodge())+
  facet_wrap(~Item, scales='fixed')+
  xlim(-5,15)

ggsave(paste(filePath, "plots/priors2-frequency-log-predictive-", prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.pdf", sep=""), width =14, height = 6)


ggplot(m2.predictive,aes(x=exp(Value), fill=Gender))+
  geom_histogram(position=position_dodge())+
  facet_wrap(~Item, scales='fixed')+
  xlim(0,1500)


ggsave(paste(filePath, "plots/frequency-predictive-", prefix, 
                   samples/1000, "k_burn", 
                   burn/1000, "k.pdf", sep=""), width =14, height = 6)

```

# Model--data fit

```{r}
# create histogram from responses
d.rate<- d.tidy %>%
  select(item, menRate, womenRate) %>%
  gather(Gender, Human, menRate, womenRate) %>%
  mutate(Gender = factor(Gender, levels=c("menRate", "womenRate"),
                         labels=c("male", "female"))) %>%
  rename(Item = item) %>%
  mutate(Bin = round(log(Human), digits = 0)) %>%
  mutate(Bin = factor(Bin)) %>%
  group_by(Item, Gender, Bin) %>%
  summarize(count = length(Human)) %>%
  ungroup() %>%
  group_by(Item, Gender) %>%
  mutate(norm_count = count / sum(count)) %>%
  select(-count)



m.rate <- m2.predictive %>% 
  mutate(Bin = round(Value, 0)) %>%
  mutate(Bin = factor(Bin)) %>%
  group_by(Item, Gender, Bin) %>%
  summarize(count = length(Value)) %>%
  ungroup() %>%
  group_by(Item, Gender) %>%
  mutate(model_count = count / sum(count)) %>%
  select(-count)

md.rate<- left_join(m.rate, d.rate)
md.rate[is.na(md.rate$norm_count),]$norm_count <- 0

ggplot(md.rate, aes(x=model_count, y=norm_count, color = Bin))+
  geom_point()+
  geom_abline(intercept = 0, slope = 1, lty = 2)+
  coord_fixed()+
  xlim(-0.05,1.05)+
  ylim(-0.05,1.05)

with(md.rate, cor(model_count, norm_count))^2


md.rate<- md.rate %>%
  mutate(sqErr = (model_count - norm_count)^2)

View(md.rate)
```
